#! /usr/bin/env ruby

require 'optparse'

require_relative '../lib/draughts'
require_relative '../lib/draughts/ai'
require_relative '../lib/draughts/ai/training_bot'

$quiet = false
$pause = false
logfile = nil
parser = OptionParser.new
parser.on("-p") { $pause = true }
parser.on("-q") { $quiet = true }
parser.on("--output=FILE") { |file| logfile = file }
parser.parse(ARGV)
ARGV.clear
$log = logfile ? File.open(File.expand_path(logfile), "a") : $stdout

def log(msg="")
  return if $quiet
  $log.write(msg)
  $log.write("\n")
  $log.flush
  gets if $log == $stdout && $pause
end

def log_board(game)
  log "Board is now:\n\n" + game.to_s
end

game = Draughts::Engine::Game.new
players = [
  Draughts::AI::TrainingBot.new(:black),
  Draughts::AI::TrainingBot.new(:white),
]

puts "Starting game..."

loop do
  players.each { |p| p.configuration = game.standard_notation }

  player = players.shift

  log "It's #{player.color}'s turn"

  move = player.play
  log "#{player.color} played #{move}"

  result = game.play(move.origin, move.destination)
  player.learn(result.success)

  log "#{move} was #{result.success ? "" : "not"} legal. Learned."

  if result.success
    players.push(player)
  else
    players.unshift(player)
  end

  log_board(game)

  break if result.ends_game
end

puts "#{players.last.color} won!"
$log.close
